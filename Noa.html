<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#2563eb" />
  <title>Noa - Assistant IA</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      height: 100vh;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    .header {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      padding: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
    }

    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .mode-badge {
      background: rgba(255,255,255,0.2);
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .header-buttons {
      display: flex;
      gap: 0.25rem;
    }
    
    .icon-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 1.25rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .icon-btn:active {
      background: rgba(255,255,255,0.3);
      transform: scale(0.95);
    }

    .icon-btn.active {
      background: #22c55e;
    }
    
    .chat-container {
      height: calc(100vh - 140px);
      overflow-y: auto;
      padding: 1rem;
      scroll-behavior: smooth;
    }
    
    .message {
      margin-bottom: 1rem;
      display: flex;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user { justify-content: flex-end; }
    .message.assistant { justify-content: flex-start; }
    
    .message-content {
      max-width: 85%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      word-wrap: break-word;
      white-space: pre-wrap;
      position: relative;
    }
    
    .message.user .message-content {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    
    .message.assistant .message-content {
      background: #1e293b;
      color: #e2e8f0;
      border-bottom-left-radius: 0.25rem;
      border: 1px solid #334155;
    }
    
    .message.system .message-content {
      background: #14532d;
      color: #86efac;
      border: 1px solid #166534;
      text-align: center;
      max-width: 100%;
      font-size: 0.9rem;
    }

    .message.error .message-content {
      background: #7f1d1d;
      color: #fca5a5;
      border: 1px solid #991b1b;
    }

    .speak-btn {
      margin-left: 0.5rem;
      background: #3b82f6;
      border: none;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      cursor: pointer;
    }
    
    .loading {
      display: flex;
      gap: 0.3rem;
      padding: 0.75rem 1rem;
    }
    
    .loading-dot {
      width: 8px;
      height: 8px;
      background: #64748b;
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }
    
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1e293b;
      padding: 0.5rem;
      display: flex;
      gap: 0.5rem;
      border-top: 1px solid #334155;
      align-items: center;
    }

    .input-tools {
      display: flex;
      gap: 0.25rem;
    }

    .tool-btn {
      background: #334155;
      border: none;
      color: #94a3b8;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .tool-btn:active {
      transform: scale(0.95);
      background: #475569;
    }

    .tool-btn.active {
      background: #ef4444;
      color: white;
    }
    
    .input-area input {
      flex: 1;
      background: #0f172a;
      border: 1px solid #334155;
      color: white;
      padding: 0.75rem;
      border-radius: 1.5rem;
      font-size: 1rem;
      outline: none;
    }
    
    .input-area input:focus {
      border-color: #3b82f6;
    }
    
    .send-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      color: white;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    
    .send-btn:active {
      transform: scale(0.95);
    }
    
    .send-btn:disabled {
      background: #475569;
      opacity: 0.5;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      animation: fadeIn 0.3s;
      overflow-y: auto;
    }
    
    .modal.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 1rem;
      padding-top: 2rem;
    }
    
    .modal-content {
      background: #1e293b;
      border-radius: 1rem;
      padding: 1.5rem;
      width: 100%;
      max-width: 500px;
      border: 1px solid #334155;
      margin-bottom: 2rem;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .modal-header h2 {
      font-size: 1.25rem;
      color: #f1f5f9;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #cbd5e1;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      background: #0f172a;
      border: 1px solid #334155;
      color: white;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: inherit;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .save-btn {
      width: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      color: white;
      padding: 1rem;
      border-radius: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 0.5rem;
    }
    
    .save-btn:active {
      transform: scale(0.98);
    }

    .delete-btn {
      width: 100%;
      background: #7f1d1d;
      border: none;
      color: white;
      padding: 1rem;
      border-radius: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .delete-btn:active {
      transform: scale(0.98);
    }
    
    .info-text {
      background: #0f172a;
      padding: 1rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 1rem;
      border: 1px solid #334155;
      line-height: 1.5;
    }
    
    .success-text {
      background: #14532d;
      padding: 1rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      color: #86efac;
      margin-bottom: 1rem;
      border: 1px solid #166534;
      line-height: 1.5;
    }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    
    .status-indicator.active {
      background: #22c55e;
      box-shadow: 0 0 8px #22c55e;
    }
    
    .status-indicator.inactive {
      background: #ef4444;
    }

    .key-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.5rem;
    }

    .input-wrapper {
      position: relative;
    }

    .memory-item {
      background: #0f172a;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid #334155;
    }

    .memory-item strong {
      color: #60a5fa;
      display: block;
      margin-bottom: 0.5rem;
    }

    .char-count {
      text-align: right;
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .memory-delete {
      float: right;
      background: #7f1d1d;
      border: none;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .mode-card {
      background: #0f172a;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
      border: 2px solid #334155;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mode-card.active {
      border-color: #3b82f6;
      background: #1e293b;
    }

    .mode-card h3 {
      color: #60a5fa;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .mode-card p {
      color: #94a3b8;
      font-size: 0.85rem;
    }

    #imageInput {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <h1>
        <span class="status-indicator" id="statusIndicator"></span>
        <span id="noaMood">üòä</span> Noa
      </h1>
      <span class="mode-badge" id="modeBadge">ü§ù Pote</span>
    </div>
    <div class="header-buttons">
      <button class="icon-btn" id="voiceToggle" onclick="toggleVoice()" title="Voix">üîá</button>
      <button class="icon-btn" onclick="openModes()" title="Modes">üé≠</button>
      <button class="icon-btn" onclick="openMemory()" title="M√©moire">üß†</button>
      <button class="icon-btn" onclick="openSettings()" title="Param√®tres">‚öôÔ∏è</button>
    </div>
  </div>

  <div class="chat-container" id="chatContainer"></div>

  <div class="input-area">
    <div class="input-tools">
      <button class="tool-btn" id="micBtn" onclick="toggleVoiceInput()" title="Micro">üé§</button>
      <button class="tool-btn" onclick="triggerImageUpload()" title="Photo">üì∏</button>
    </div>
    <input 
      type="text" 
      id="userInput" 
      placeholder="√âcris..."
      autocomplete="off"
    />
    <input type="file" id="imageInput" accept="image/*" capture="environment" onchange="handleImageUpload(event)" />
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚ñ∂Ô∏è</button>
  </div>

  <div class="modal" id="modesModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üé≠ Modes</h2>
        <button class="close-btn" onclick="closeModes()">‚úï</button>
      </div>
      
      <div class="info-text">
        üí° Choisis le style de Noa
      </div>

      <div class="mode-card" onclick="setMode('pote')">
        <h3>ü§ù Pote</h3>
        <p>D√©contract√© et fun</p>
      </div>

      <div class="mode-card" onclick="setMode('coach')">
        <h3>üí™ Coach</h3>
        <p>Motivant</p>
      </div>

      <div class="mode-card" onclick="setMode('psy')">
        <h3>üßò Psy</h3>
        <p>Empathique</p>
      </div>

      <div class="mode-card" onclick="setMode('prof')">
        <h3>üìö Prof</h3>
        <p>P√©dagogue</p>
      </div>

      <div class="mode-card" onclick="setMode('expert')">
        <h3>üéØ Expert</h3>
        <p>Technique</p>
      </div>
    </div>
  </div>

  <div class="modal" id="memoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üß† M√©moire</h2>
        <button class="close-btn" onclick="closeMemory()">‚úï</button>
      </div>
      
      <div class="info-text">
        üí° Noa se souviendra
      </div>

      <div id="memoryList"></div>
      
      <div class="form-group">
        <label>üìù Ajouter</label>
        <textarea 
          id="memoryInput" 
          placeholder="Ex: Je m'appelle..."
          maxlength="500"
          oninput="updateCharCount()"
        ></textarea>
        <div class="char-count" id="charCount">0/500</div>
      </div>
      
      <button class="save-btn" onclick="addMemory()">üíæ Ajouter</button>
      <button class="delete-btn" onclick="clearAllMemory()">üóëÔ∏è Effacer</button>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚öôÔ∏è Param√®tres</h2>
        <button class="close-btn" onclick="closeSettings()">‚úï</button>
      </div>
      
      <div class="success-text">
        ‚úÖ Gemini GRATUIT
      </div>
      
      <div class="form-group">
        <label>ü§ñ Fournisseur</label>
        <select id="providerSelect" onchange="updateProvider()">
          <option value="gemini">Gemini</option>
          <option value="openai">OpenAI</option>
        </select>
      </div>
      
      <div class="form-group" id="geminiKey">
        <label>üîë Cl√© Gemini</label>
        <div class="info-text">
          üìç aistudio.google.com/apikey
        </div>
        <div class="input-wrapper">
          <input 
            type="password" 
            id="geminiApiKey" 
            placeholder="AIza..."
          />
          <button class="key-toggle" onclick="toggleKeyVisibility('geminiApiKey')">üëÅÔ∏è</button>
        </div>
      </div>
      
      <div class="form-group" id="openaiKey" style="display: none;">
        <label>üîë Cl√© OpenAI</label>
        <div class="input-wrapper">
          <input 
            type="password" 
            id="openaiApiKey" 
            placeholder="sk-..."
          />
          <button class="key-toggle" onclick="toggleKeyVisibility('openaiApiKey')">üëÅÔ∏è</button>
        </div>
      </div>
      
      <div class="form-group">
        <label>üéØ Mod√®le</label>
        <select id="modelSelect">
          <option value="gemini-2.0-flash-exp">Gemini 2.0 ‚ö°</option>
          <option value="gemini-1.5-pro-latest">Gemini Pro üí™</option>
          <option value="gemini-1.5-flash">Gemini Flash ‚öñÔ∏è</option>
        </select>
      </div>
      
      <button class="save-btn" onclick="saveSettings()">üíæ Enregistrer</button>
    </div>
  </div>

  <script>
    let isLoading = false;
    let isRecording = false;
    let recognition = null;
    let synthesis = window.speechSynthesis;
    let voiceEnabled = false;
    let currentSpeech = null;
    
    let config = {
      provider: 'gemini',
      openaiKey: '',
      geminiKey: '',
      model: 'gemini-2.0-flash-exp',
      mode: 'pote'
    };
    
    let memory = [];
    let conversationHistory = [];
    let noaMood = 'üòä';

    const moods = ['üòä', 'ü§ó', 'üòÑ', 'üåü', 'üí´'];
    
    const modeConfig = {
      pote: {
        emoji: 'ü§ù',
        label: 'Pote',
        prompt: 'Tu es un ami proche, d√©contract√©.'
      },
      coach: {
        emoji: 'üí™',
        label: 'Coach',
        prompt: 'Tu es motivant.'
      },
      psy: {
        emoji: 'üßò',
        label: 'Psy',
        prompt: 'Tu es bienveillant et empathique.'
      },
      prof: {
        emoji: 'üìö',
        label: 'Prof',
        prompt: 'Tu es p√©dagogue.'
      },
      expert: {
        emoji: 'üéØ',
        label: 'Expert',
        prompt: 'Tu es technique.'
      }
    };

    function loadConfig() {
      const saved = localStorage.getItem('noaConfig');
      if (saved) config = JSON.parse(saved);
      
      const savedMemory = localStorage.getItem('noaMemory');
      if (savedMemory) memory = JSON.parse(savedMemory);

      const savedHistory = localStorage.getItem('noaHistory');
      if (savedHistory) conversationHistory = JSON.parse(savedHistory);

      updateStatusIndicator();
      updateModeBadge();
      
      if (config.geminiKey || config.openaiKey) {
        const hour = new Date().getHours();
        let welcome = hour < 12 ? '‚òÄÔ∏è Salut !' : hour < 18 ? 'üå§Ô∏è Coucou !' : 'üåÜ Bonsoir !';
        addMessage('assistant', welcome);
      } else {
        addMessage('assistant', 'üëã Configure ta cl√© Gemini ‚öôÔ∏è\n\naistudio.google.com/apikey');
      }

      setInterval(changeMood, 30000);
    }

    function changeMood() {
      noaMood = moods[Math.floor(Math.random() * moods.length)];
      document.getElementById('noaMood').textContent = noaMood;
    }

    function updateModeBadge() {
      const mode = modeConfig[config.mode] || modeConfig.pote;
      document.getElementById('modeBadge').innerHTML = `${mode.emoji} ${mode.label}`;
      document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('active'));
    }

    function updateStatusIndicator() {
      const indicator = document.getElementById('statusIndicator');
      const hasKey = (config.provider === 'openai' && config.openaiKey) || 
                     (config.provider === 'gemini' && config.geminiKey);
      indicator.className = 'status-indicator ' + (hasKey ? 'active' : 'inactive');
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const btn = document.getElementById('voiceToggle');
      btn.textContent = voiceEnabled ? 'üîä' : 'üîá';
      btn.classList.toggle('active', voiceEnabled);
      if (!voiceEnabled && currentSpeech) {
        synthesis.cancel();
      }
      
      if (voiceEnabled) {
        addMessage('system', 'üîä Voix activ√©e');
      }
    }

    function speakText(text) {
      if (!voiceEnabled) return;
      
      try {
        if (currentSpeech) synthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'fr-FR';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        currentSpeech = utterance;
        
        utterance.onerror = (e) => {
          console.error('Erreur voix:', e);
        };
        
        synthesis.speak(utterance);
      } catch (error) {
        console.error('Erreur synth√®se vocale:', error);
      }
    }

    function toggleVoiceInput() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (!SpeechRecognition) {
        addMessage('error', '‚ùå Micro non support√© sur ce navigateur');
        return;
      }

      if (isRecording) {
        stopVoiceInput();
      } else {
        startVoiceInput();
      }
    }

    function startVoiceInput() {
      try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'fr-FR';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => {
          isRecording = true;
          document.getElementById('micBtn').classList.add('active');
          document.getElementById('userInput').placeholder = 'üé§ √âcoute...';
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          document.getElementById('userInput').value = transcript;
          stopVoiceInput();
          setTimeout(() => sendMessage(), 100);
        };

        recognition.onerror = (e) => {
          console.error('Erreur micro:', e);
          stopVoiceInput();
          addMessage('error', '‚ùå Erreur micro: ' + e.error);
        };

        recognition.onend = () => {
          stopVoiceInput();
        };

        recognition.start();
      } catch (error) {
        console.error('Erreur d√©marrage micro:', error);
        addMessage('error', '‚ùå Impossible de d√©marrer le micro');
      }
    }

    function stopVoiceInput() {
      if (recognition) {
        try {
          recognition.stop();
        } catch(e) {}
      }
      isRecording = false;
      document.getElementById('micBtn').classList.remove('active');
      document.getElementById('userInput').placeholder = '√âcris...';
    }

    function triggerImageUpload() {
      document.getElementById('imageInput').click();
    }

    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        addMessage('error', '‚ùå Fichier doit √™tre une image');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const base64 = e.target.result.split(',')[1];
          
          addMessage('user', 'üì∏ [Image envoy√©e]');
          
          const loadingId = addLoadingMessage();
          
          const response = await analyzeImage(base64, file.type);
          removeMessage(loadingId);
          addMessage('assistant', response);
          if (voiceEnabled) speakText(response);
        } catch (error) {
          removeMessage(loadingId);
          addMessage('error', '‚ùå Erreur: ' + error.message);
        }
      };
      
      reader.onerror = () => {
        addMessage('error', '‚ùå Impossible de lire l\'image');
      };
      
      reader.readAsDataURL(file);
      event.target.value = '';
    }

    async function analyzeImage(base64Image, mimeType) {
      if (config.provider !== 'gemini') {
        throw new Error('Vision = Gemini uniquement');
      }

      if (!config.geminiKey) {
        throw new Error('Configure ta cl√© Gemini d\'abord');
      }

      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${config.geminiKey}`;
      
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: 'D√©cris cette image en fran√ßais de fa√ßon d√©taill√©e et utile.' },
              { 
                inline_data: { 
                  mime_type: mimeType || 'image/jpeg', 
                  data: base64Image 
                }
              }
            ]
          }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 1024
          }
        })
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error?.message || 'Erreur analyse image');
      }
      
      const data = await response.json();
      
      if (!data.candidates || !data.candidates[0]) {
        throw new Error('Pas de r√©ponse de Gemini');
      }
      
      return data.candidates[0].content.parts[0].text;
    }

    function openModes() {
      document.getElementById('modesModal').classList.add('active');
    }

    function closeModes() {
      document.getElementById('modesModal').classList.remove('active');
    }

    function setMode(mode) {
      config.mode = mode;
      localStorage.setItem('noaConfig', JSON.stringify(config));
      updateModeBadge();
      closeModes();
      const modeInfo = modeConfig[mode] || modeConfig.pote;
      addMessage('system', `Mode ${modeInfo.emoji} ${modeInfo.label} activ√© !`);
    }

    function openMemory() {
      document.getElementById('memoryModal').classList.add('active');
      displayMemoryList();
    }

    function closeMemory() {
      document.getElementById('memoryModal').classList.remove('active');
    }

    function displayMemoryList() {
      const list = document.getElementById('memoryList');
      if (memory.length === 0) {
        list.innerHTML = '<div class="info-text">üì≠ Aucune info</div>';
      } else {
        list.innerHTML = memory.map((item, index) => `
          <div class="memory-item">
            <strong>üìå ${index + 1}</strong>
            ${item}
            <button class="memory-delete" onclick="deleteMemory(${index})">üóëÔ∏è</button>
          </div>
        `).join('');
      }
    }

    function addMemory() {
      const input = document.getElementById('memoryInput');
      const text = input.value.trim();
      
      if (!text) {
        alert('‚ö†Ô∏è √âcris quelque chose');
        return;
      }
      
      memory.push(text);
      localStorage.setItem('noaMemory', JSON.stringify(memory));
      input.value = '';
      displayMemoryList();
      updateCharCount();
      closeMemory();
      
      addMessage('assistant', '‚úÖ M√©moris√© !');
    }

    function deleteMemory(index) {
      if (confirm('Supprimer ?')) {
        memory.splice(index, 1);
        localStorage.setItem('noaMemory', JSON.stringify(memory));
        displayMemoryList();
      }
    }

    function clearAllMemory() {
      if (confirm('‚ö†Ô∏è Tout effacer ?')) {
        memory = [];
        localStorage.setItem('noaMemory', JSON.stringify(memory));
        displayMemoryList();
        addMessage('system', 'üóëÔ∏è M√©moire effac√©e');
      }
    }

    function updateCharCount() {
      const input = document.getElementById('memoryInput');
      const count = document.getElementById('charCount');
      if (input && count) {
        count.textContent = `${input.value.length}/500`;
      }
    }

    function openSettings() {
      document.getElementById('settingsModal').classList.add('active');
      document.getElementById('providerSelect').value = config.provider;
      document.getElementById('openaiApiKey').value = config.openaiKey;
      document.getElementById('geminiApiKey').value = config.geminiKey;
      document.getElementById('modelSelect').value = config.model;
      updateProvider();
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    function toggleKeyVisibility(inputId) {
      const input = document.getElementById(inputId);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function updateProvider() {
      const provider = document.getElementById('providerSelect').value;
      const modelSelect = document.getElementById('modelSelect');
      
      if (provider === 'openai') {
        document.getElementById('openaiKey').style.display = 'block';
        document.getElementById('geminiKey').style.display = 'none';
        modelSelect.innerHTML = `
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4o-mini">GPT-4o-mini</option>
        `;
      } else {
        document.getElementById('openaiKey').style.display = 'none';
        document.getElementById('geminiKey').style.display = 'block';
        modelSelect.innerHTML = `
          <option value="gemini-2.0-flash-exp">Gemini 2.0 ‚ö°</option>
          <option value="gemini-1.5-pro-latest">Gemini Pro üí™</option>
          <option value="gemini-1.5-flash">Gemini Flash ‚öñÔ∏è</option>
        `;
      }
    }

    async function saveSettings() {
      config.provider = document.getElementById('providerSelect').value;
      config.openaiKey = document.getElementById('openaiApiKey').value.trim();
      config.geminiKey = document.getElementById('geminiApiKey').value.trim();
      config.model = document.getElementById('modelSelect').value;
      
      const hasKey = (config.provider === 'openai' && config.openaiKey) || 
                     (config.provider === 'gemini' && config.geminiKey);
      
      if (!hasKey) {
        alert('‚ö†Ô∏è Entre une cl√© API');
        return;
      }
      
      localStorage.setItem('noaConfig', JSON.stringify(config));
      updateStatusIndicator();
      closeSettings();
      
      addMessage('assistant', '‚úÖ Sauvegard√© ! Test...');
      
      try {
        const response = config.provider === 'openai' 
          ? await callOpenAI('Dis OK') 
          : await callGemini('Dis OK');
        
        addMessage('assistant', 'üéâ √áa marche !');
      } catch (error) {
        addMessage('error', '‚ùå ' + error.message);
      }
    }

    function getMemoryContext() {
      if (memory.length === 0) return '';
      return '\n\nINFOS utilisateur:\n' + memory.join('\n');
    }

    function getConversationContext() {
      if (conversationHistory.length === 0) return '';
      const recent = conversationHistory.slice(-4);
      return '\n\nHistorique:\n' + recent.map(h => `${h.role}: ${h.content}`).join('\n');
    }

    function getModePrompt() {
      const mode = modeConfig[config.mode] || modeConfig.pote;
      return mode.prompt;
    }

    async function sendMessage() {
      if (isLoading) return;
      
      const hasKey = (config.provider === 'openai' && config.openaiKey) || 
                     (config.provider === 'gemini' && config.geminiKey);
      
      if (!hasKey) {
        addMessage('error', '‚ö†Ô∏è Configure ta cl√© ‚öôÔ∏è\n\naistudio.google.com/apikey');
        return;
      }
      
      const input = document.getElementById('userInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      addMessage('user', text);
      input.value = '';
      
      conversationHistory.push({ role: 'user', content: text });
      if (conversationHistory.length > 20) conversationHistory.shift();
      localStorage.setItem('noaHistory', JSON.stringify(conversationHistory));
      
      isLoading = true;
      document.getElementById('sendBtn').disabled = true;
      
      const loadingId = addLoadingMessage();
      
      try {
        const response = config.provider === 'openai' 
          ? await callOpenAI(text) 
          : await callGemini(text);
        
        removeMessage(loadingId);
        addMessage('assistant', response);
        
        conversationHistory.push({ role: 'assistant', content: response });
        localStorage.setItem('noaHistory', JSON.stringify(conversationHistory));
        
        if (voiceEnabled) {
          speakText(response);
        }
        
      } catch (error) {
        removeMessage(loadingId);
        addMessage('error', '‚ùå ' + error.message);
      } finally {
        isLoading = false;
        document.getElementById('sendBtn').disabled = false;
      }
    }

    async function callOpenAI(message) {
      const systemPrompt = `Tu es Noa. ${getModePrompt()}${getMemoryContext()}${getConversationContext()}`;
      
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${config.openaiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: config.model,
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: message }
          ],
          max_tokens: 1000
        })
      });
      
      if (!response.ok) throw new Error('Erreur API');
      const data = await response.json();
      return data.choices[0].message.content;
    }

    async function callGemini(message) {
      const fullMessage = message + getMemoryContext() + getConversationContext();
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.geminiKey}`;
      
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: fullMessage }] }],
          systemInstruction: { parts: [{ text: `Tu es Noa. ${getModePrompt()} R√©ponds en fran√ßais.` }] },
          generationConfig: { temperature: 0.9, maxOutputTokens: 2048 },
          safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
          ]
        })
      });
      
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        if (err.error?.message?.includes('API_KEY_INVALID')) {
          throw new Error('Cl√© invalide');
        }
        throw new Error(err.error?.message || 'Erreur Gemini');
      }
      
      const data = await response.json();
      return data.candidates[0].content.parts[0].text;
    }

    function addMessage(type, text) {
      const container = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      const msgId = 'msg-' + Date.now();
      messageDiv.id = msgId;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.textContent = text;
      
      if (type === 'assistant' && voiceEnabled) {
        const speakBtn = document.createElement('button');
        speakBtn.className = 'speak-btn';
        speakBtn.innerHTML = 'üîä';
        speakBtn.onclick = () => speakText(text);
        contentDiv.appendChild(speakBtn);
      }
      
      messageDiv.appendChild(contentDiv);
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
      
      return msgId;
    }

    function addLoadingMessage() {
      const container = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';
      messageDiv.id = 'loading-' + Date.now();
      
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading';
      loadingDiv.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';
      
      messageDiv.appendChild(loadingDiv);
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
      
      return messageDiv.id;
    }

    function removeMessage(id) {
      const element = document.getElementById(id);
      if (element) element.remove();
    }

    document.getElementById('userInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    loadConfig();
  </script>
</body>
</html>