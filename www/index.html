<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>No√§</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  color:#fff;background:#000 url('img/noa.jpg') center/cover no-repeat fixed;overflow:hidden
}
.overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.25) 0%,rgba(34,0,51,.5) 50%,rgba(0,0,0,.65) 100%);pointer-events:none}
.status{position:fixed;top:18px;left:18px;padding:8px 12px;border-radius:16px;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);font-size:14px}
.fab{position:fixed;top:14px;right:14px;display:flex;align-items:center;gap:8px;padding:8px 12px;border:0;border-radius:18px;background:rgba(0,0,0,.35);color:#fff;font-size:16px;cursor:pointer}
.fab:active{transform:scale(.98)}
.input-bar{position:fixed;left:0;right:0;bottom:16px;display:flex;gap:10px;padding:0 16px}
.input{flex:1;border:0;border-radius:26px;padding:14px 16px;font-size:16px;background:rgba(255,255,255,.92);color:#222;outline:none}
.btn{min-width:52px;height:52px;border:0;border-radius:50%;font-size:20px;color:#fff;cursor:pointer;background:rgba(255,255,255,.18);backdrop-filter:blur(8px)}
.btn:active{transform:scale(.96)}
.btn.primary{background:#3b82f6}
.btn.listening{background:#ff4757;box-shadow:0 0 0 0 rgba(255,71,87,.7);animation:rec 1.2s infinite}
@keyframes rec{50%{box-shadow:0 0 0 12px rgba(255,71,87,0)}}
.toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:rgba(0,0,0,.55);backdrop-filter:blur(6px);padding:10px 14px;border-radius:14px;font-size:14px;display:none}
.toast.show{display:block}

/* Panel */
.panel-wrap{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);display:none}
.panel{position:absolute;right:0;top:0;bottom:0;width:86%;max-width:380px;background:rgba(8,8,12,.92);color:#fff;padding:18px 16px 90px 16px;overflow:auto}
.panel h2{font-size:18px;margin-bottom:8px}
.row{margin:10px 0;display:flex;align-items:center;justify-content:space-between;gap:10px}
.row label{font-size:14px;opacity:.9}
.row input[type="checkbox"]{transform:scale(1.2)}
.row input[type="range"]{width:55%}
.select{background:#0f172a;border:1px solid #243048;color:#fff;border-radius:10px;padding:8px 10px}
.panel .btn-row{position:sticky;bottom:0;display:flex;gap:10px;background:linear-gradient(180deg,transparent,rgba(8,8,12,.92) 30%);padding-top:12px;padding-bottom:6px}
.btn.full{flex:1;border-radius:12px;height:44px}
.link{color:#93c5fd;font-size:13px;text-decoration:underline;background:none;border:0}
.showPanel{display:block}
</style>
</head>
<body>
<div class="overlay"></div>
<div class="status" id="status">No√§ ‚Ä¢ En ligne</div>
<button id="openSettings" class="fab">‚öôÔ∏è Param√®tres</button>

<div class="input-bar">
  <input id="text-input" class="input" placeholder="Parle √† No√§...">
  <button id="mic-btn" class="btn">üé§</button>
  <button id="send-btn" class="btn primary">Envoyer</button>
</div>

<div id="toast" class="toast"></div>

<div id="panelWrap" class="panel-wrap">
  <div class="panel">
    <h2>Param√®tres</h2>

    <div class="row">
      <label for="lang">Langue</label>
      <select id="lang" class="select">
        <option value="fr-FR">Fran√ßais (FR)</option>
        <option value="en-US">English (US)</option>
      </select>
    </div>

    <div class="row">
      <label for="ttsEnable">Synth√®se vocale</label>
      <input id="ttsEnable" type="checkbox">
    </div>

    <div class="row">
      <label for="rate">Vitesse voix</label>
      <input id="rate" type="range" min="0.7" max="1.3" step="0.05">
    </div>

    <div class="row">
      <label for="wake">Garder l‚Äô√©cran allum√©</label>
      <input id="wake" type="checkbox">
    </div>

    <div class="row" style="justify-content:flex-start">
      <button id="clearHistory" class="link">Effacer l‚Äôhistorique</button>
    </div>

    <div class="btn-row">
      <button id="closeSettings" class="btn full">Fermer</button>
      <button id="saveSettings" class="btn primary full">Enregistrer</button>
    </div>
  </div>
</div>

<script src="cordova.js"></script>
<script>
let isListening=false;
let settings={lang:'fr-FR',tts:true,rate:1.0,wake:false};
let wakeLockObj=null;

function loadSettings(){
  try{ const s=JSON.parse(localStorage.getItem('noaSettings')); if(s) settings=Object.assign(settings,s);}catch(e){}
  document.getElementById('lang').value=settings.lang;
  document.getElementById('ttsEnable').checked=settings.tts;
  document.getElementById('rate').value=settings.rate;
  document.getElementById('wake').checked=settings.wake;
}
function saveSettings(){
  settings.lang=document.getElementById('lang').value;
  settings.tts=document.getElementById('ttsEnable').checked;
  settings.rate=parseFloat(document.getElementById('rate').value);
  settings.wake=document.getElementById('wake').checked;
  localStorage.setItem('noaSettings',JSON.stringify(settings));
  applyWake(settings.wake);
  toast('Param√®tres enregistr√©s');
}
async function applyWake(on){
  try{
    if('wakeLock' in navigator){
      if(on && !wakeLockObj){ wakeLockObj=await navigator.wakeLock.request('screen'); }
      if(!on && wakeLockObj){ await wakeLockObj.release(); wakeLockObj=null; }
      document.addEventListener('visibilitychange',async()=>{ if(document.visibilityState==='visible' && settings.wake){ try{ wakeLockObj=await navigator.wakeLock.request('screen'); }catch(_){}}});
    }
  }catch(_){}
}
function toast(msg){
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1300);
}
function speak(text){
  if(settings.tts && window.TTS){
    TTS.speak({text,locale:settings.lang,rate:settings.rate});
  }
}
function generateResponse(input){
  const map={'bonjour':'Bonsoir ! Que puis-je faire pour toi ?','salut':'Salut !','qui es-tu':'Je suis No√§, ton assistante.','merci':'Avec plaisir !'};
  const k=input.toLowerCase(); for(const key in map){ if(k.includes(key)) return map[key]; } return "Je t‚Äô√©coute.";
}
function sendMessage(text){
  if(!text||!text.trim()) return;
  const res=generateResponse(text.trim());
  localStorage.setItem('noaLast',JSON.stringify({q:text, a:res, t:Date.now()}));
  toast(res); speak(res);
}
function startListening(){
  if(!window.plugins||!window.plugins.speechRecognition){ toast('Micro indisponible'); return; }
  const mic=document.getElementById('mic-btn');
  if(isListening){ window.plugins.speechRecognition.stopListening(); mic.classList.remove('listening'); isListening=false; return; }
  window.plugins.speechRecognition.hasPermission(ok=>{
    if(!ok){
      window.plugins.speechRecognition.requestPermission(()=>begin(),()=>toast('Permission refus√©e'));
    }else begin();
  });
  function begin(){
    isListening=true; mic.classList.add('listening');
    window.plugins.speechRecognition.startListening((res)=>{
      mic.classList.remove('listening'); isListening=false;
      if(res&&res.length){ const v=res[0]; document.getElementById('text-input').value=v; sendMessage(v); }
    },(_)=>{ mic.classList.remove('listening'); isListening=false; },{language:settings.lang,showPopup:false});
  }
}

document.addEventListener('deviceready',()=>{
  if(cordova.plugins&&cordova.plugins.permissions){
    const p=cordova.plugins.permissions;
    p.requestPermissions([p.RECORD_AUDIO,p.MODIFY_AUDIO_SETTINGS],()=>{},()=>{});
  }
  loadSettings();
  applyWake(settings.wake);
  document.getElementById('status').textContent='No√§ ‚Ä¢ En ligne';
});

document.getElementById('send-btn').addEventListener('click',()=>{
  const i=document.getElementById('text-input'); sendMessage(i.value); i.value='';
});
document.getElementById('text-input').addEventListener('keypress',(e)=>{
  if(e.key==='Enter'){ sendMessage(e.target.value); e.target.value=''; }
});
document.getElementById('mic-btn').addEventListener('click',startListening);

const panelWrap=document.getElementById('panelWrap');
document.getElementById('openSettings').addEventListener('click',()=>{ loadSettings(); panelWrap.classList.add('showPanel'); });
document.getElementById('closeSettings').addEventListener('click',()=>panelWrap.classList.remove('showPanel'));
document.getElementById('saveSettings').addEventListener('click',()=>{ saveSettings(); panelWrap.classList.remove('showPanel'); });
document.getElementById('clearHistory').addEventListener('click',()=>{ localStorage.removeItem('noaHistory'); localStorage.removeItem('noaLast'); toast('Historique effac√©'); });
panelWrap.addEventListener('click',(e)=>{ if(e.target===panelWrap) panelWrap.classList.remove('showPanel'); });
</script>
</body>
</html>
