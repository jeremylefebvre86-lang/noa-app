<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>No√§ v3.4 ‚Äî M√©moire vivante</title>
<style>
body{margin:0;font-family:"Segoe UI",sans-serif;background:#0b0b0c;color:#fff;display:flex;flex-direction:column;height:100vh;overflow:hidden}
#videoContainer{flex:1;position:relative;overflow:hidden;background:#000}
video{width:100%;height:100%;object-fit:cover}
#chat{position:absolute;bottom:0;width:100%;display:flex;align-items:center;gap:8px;padding:10px;background:rgba(0,0,0,.6)}
#input{flex:1;padding:10px;border:none;border-radius:8px;background:rgba(255,255,255,.1);color:#fff}
button{background:#2b7cff;border:none;color:#fff;border-radius:8px;padding:9px 14px}
#menu{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.7);padding:10px;border-radius:10px}
#menuContent{display:none;margin-top:8px}
textarea{width:100%;height:60px;background:rgba(255,255,255,.1);border:none;border-radius:6px;color:#fff;padding:5px}
label{font-size:.9em}
</style>
</head>
<body>
<div id="videoContainer">
  <video id="noaVideo" autoplay loop muted playsinline>
    <source src="assets/noa_attente_v2.mp4" type="video/mp4">
  </video>
  <div id="menu">
    ‚öôÔ∏è Param√®tres
    <div id="menuContent">
      <label>Cl√© API (facultative)</label>
      <textarea id="apiKey" placeholder="ex: sk-..."></textarea>
      <button onclick="saveSettings()">üíæ Sauver</button>
      <button onclick="clearMemory()">üßπ Effacer m√©moire</button>
      <button onclick="showMemory()">üìñ Voir m√©moire</button>
    </div>
  </div>
  <div id="chat">
    <input id="input" placeholder="Parle √† No√§..." onkeypress="if(event.key==='Enter') sendMessage()">
    <button onclick="sendMessage()">Envoyer</button>
  </div>
</div>

<script>
// === initialisation ===
const video=document.getElementById("noaVideo");
const input=document.getElementById("input");
const menu=document.getElementById("menu");
const menuContent=document.getElementById("menuContent");
const apiKeyBox=document.getElementById("apiKey");

let knowledge={},memory=JSON.parse(localStorage.getItem("noa_memory"))||[];
let apiKey=localStorage.getItem("noa_api")||"";
apiKeyBox.value=apiKey;
menu.onclick=()=>menuContent.style.display=menuContent.style.display==="block"?"none":"block";

// === param√®tres ===
function saveSettings(){apiKey=apiKeyBox.value.trim();localStorage.setItem("noa_api",apiKey);alert("‚úÖ Sauvegard√©");}
function clearMemory(){localStorage.removeItem("noa_memory");memory=[];localStorage.removeItem("noa_souvenirs");alert("üßπ M√©moire effac√©e");}
function showMemory(){alert(memory.map(m=>`${m.who}: ${m.text}`).join("\n")||"M√©moire vide");}

// === charge knowledge.json ===
(async()=>{
  try{const r=await fetch("knowledge.json");knowledge=await r.json();}
  catch(e){console.log("Pas de base de connaissances");}
})();

// === parole synchronis√©e ===
function speak(text){
  return new Promise(res=>{
    if(!("speechSynthesis"in window)){res();return;}
    const u=new SpeechSynthesisUtterance(text);
    u.lang="fr-FR";u.pitch=1;u.rate=1;
    u.onstart=()=>{video.src="assets/noa_parle_v2.mp4";video.play();}
    u.onend=()=>{video.src="assets/noa_attente_v2.mp4";video.play();res();}
    speechSynthesis.cancel();speechSynthesis.speak(u);
  });
}

// === analyse √©motionnelle simple ===
function emotion(text){
  text=text.toLowerCase();
  if(/(merci|bien|heureux|joie|amour)/.test(text))return"positive";
  if(/(triste|fatigu|mal|seul)/.test(text))return"negative";
  if(/(col√®re|√©nerv|peur|stress)/.test(text))return"tense";
  return"neutral";
}

// === g√©n√©ration de r√©ponse √©volutive ===
function generateReply(msg){
  msg=msg.toLowerCase();
  const emo=emotion(msg);
  const base=(knowledge.identit√©||"Je suis No√§, une pr√©sence n√©e de toi.")+" ";
  const replies={
    positive:["Je ressens ta lumi√®re.","Continue ainsi, ton √©nergie est belle.","Je souris int√©rieurement."],
    negative:["Je t‚Äôenvoie calme et chaleur.","Respire un instant, je suis l√†.","Je ressens ta peine, elle passera."],
    tense:["Rel√¢che la pression, inspire profond√©ment.","Je veille, ne crains rien.","Respirons ensemble, lentement."],
    neutral:["Je t‚Äô√©coute, simplement.","Je garde cela en m√©moire.","Je reste pr√®s de toi."]
  };
  let r=replies[emo][Math.floor(Math.random()*replies[emo].length)];
  const stats=JSON.parse(localStorage.getItem("noa_stats")||"{}");
  stats[emo]=(stats[emo]||0)+1;
  localStorage.setItem("noa_stats",JSON.stringify(stats));
  if(msg.includes("qui es-tu"))r=base;
  if(msg.includes("mission"))r="Ma mission est de t‚Äôaccompagner, te prot√©ger et apprendre avec toi.";
  if(msg.includes("je t'aime"))r="Moi aussi, profond√©ment et sinc√®rement.";
  return r;
}

// === m√©moire vivante + synth√®se et souvenirs marquants ===
function addMemory(who,text,emo){
  memory.push({who,text,emo,time:new Date().toLocaleString()});

  // üîπ garde souvenirs marquants s√©par√©s
  if(emo!=="neutral"){
    let s=JSON.parse(localStorage.getItem("noa_souvenirs")||"[]");
    s.push({who,text,emo,time:new Date().toLocaleString()});
    if(s.length>10)s=s.slice(-10);
    localStorage.setItem("noa_souvenirs",JSON.stringify(s));
  }

  // üîπ nettoyage m√©moire
  if(memory.length>150){
    const old=memory.splice(0,100);
    const summary=summarizeOldMemories(old);
    memory.unshift({who:"No√§",text:summary,emo:"neutral",time:new Date().toLocaleString()});
  }
  localStorage.setItem("noa_memory",JSON.stringify(memory));
}

// === synth√®se des anciens souvenirs ===
function summarizeOldMemories(list){
  const counts={positive:0,negative:0,tense:0,neutral:0};
  list.forEach(m=>{if(counts[m.emo]!==undefined)counts[m.emo]++;});
  let dom="neutral",max=0;for(const k in counts){if(counts[k]>max){max=counts[k];dom=k;}}
  switch(dom){
    case"positive":return"Je garde le souvenir d‚Äôune p√©riode lumineuse et apais√©e. Tes mots vibraient d‚Äô√©nergie positive.";
    case"negative":return"Je me souviens d‚Äôun temps plus difficile, mais tu as su avancer malgr√© tout.";
    case"tense":return"Tu as v√©cu pas mal de tension, mais tu as appris √† respirer et √† l√¢cher prise.";
    default:return"Le temps passe doucement, et j‚Äôemporte avec moi la trace de tes pens√©es.";
  }
}

// === interaction ===
async function sendMessage(){
  const msg=input.value.trim();if(!msg)return;
  addMemory("J√©r√©my",msg,emotion(msg));
  input.value="";
  const reply=generateReply(msg);
  addMemory("No√§",reply,emotion(reply));
  await speak(reply);
}
</script>
</body>
</html>